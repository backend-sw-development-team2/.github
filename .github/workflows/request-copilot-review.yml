name: Request Copilot Review

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        description: 'GitHub token for API access'
        required: true

jobs:
  request-copilot-review:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
    
    - name: Checkout .github repository
      uses: actions/checkout@v4
      with:
        repository: backend-sw-development-team2/.github
        path: .github-repo
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        echo "ğŸ“¦ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
        pip install requests
    
    - name: Check Copilot Reviewer
      id: check_copilot
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ” Copilot ë¦¬ë·°ì–´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."
        
        # PR ë²ˆí˜¸ëŠ” í•­ìƒ pull_request ì´ë²¤íŠ¸ì—ì„œ ê°€ì ¸ì˜´
        PR_NUMBER="${{ github.event.pull_request.number }}"
        
        echo "ğŸ“ PR ë²ˆí˜¸: $PR_NUMBER"
        
        # PRì˜ í˜„ì¬ ë¦¬ë·°ì–´ ëª©ë¡ í™•ì¸
        REVIEWERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/requested_reviewers" | \
          jq -r '.users[]?.login // empty')
        
        # PRì˜ ê¸°ì¡´ ë¦¬ë·° í™•ì¸ (Copilotì´ ì´ë¯¸ ë¦¬ë·°í–ˆëŠ”ì§€)
        REVIEWS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" | \
          jq -r '.[].user.login // empty')
        
        echo "í˜„ì¬ ë¦¬ë·°ì–´: $REVIEWERS"
        echo "ê¸°ì¡´ ë¦¬ë·°ì–´: $REVIEWS"
        
        # Copilotì´ ì´ë¯¸ ë¦¬ë·°ì–´ë¡œ ìˆê±°ë‚˜ ë¦¬ë·°ë¥¼ ë‚¨ê²¼ëŠ”ì§€ í™•ì¸
        COPILOT_EXISTS=false
        if echo "$REVIEWERS $REVIEWS" | grep -q "copilot-pull-request-reviewer\[bot\]"; then
          COPILOT_EXISTS=true
        fi
        
        if [ "$COPILOT_EXISTS" = "true" ]; then
          echo "âœ… Copilot ë¦¬ë·°ì–´ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ë¦¬ë·°ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
          echo "skip_copilot=true" >> $GITHUB_OUTPUT
        else
          echo "â¡ï¸ Copilot ë¦¬ë·°ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
          echo "skip_copilot=false" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi
    
    - name: Download and Setup MCP Server
      if: steps.check_copilot.outputs.skip_copilot == 'false'
      run: |
        echo "ğŸ“¥ GitHub MCP ì„œë²„ ë‹¤ìš´ë¡œë“œ ì¤‘..."
        
        # GitHub MCP ì„œë²„ê°€ ë¡œì»¬ì— ìˆëŠ”ì§€ í™•ì¸
        if [ -f ./github-mcp-server ]; then
          echo "âœ… ë¡œì»¬ì—ì„œ GitHub MCP ì„œë²„ ë°œê²¬ë¨"
          chmod +x ./github-mcp-server
        else
          echo "â¬‡ï¸  GitHub MCP ì„œë²„ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤..."
          
          # GitHub ê³µì‹ MCP ì„œë²„ ë‹¤ìš´ë¡œë“œ (Linux x86_64 ë²„ì „)
          curl -L -o github-mcp-server.tar.gz \
            "https://github.com/github/github-mcp-server/releases/latest/download/github-mcp-server_Linux_x86_64.tar.gz"
          
          # ì••ì¶• í•´ì œ
          tar -xzf github-mcp-server.tar.gz
          
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x github-mcp-server
          
          echo "âœ… GitHub MCP ì„œë²„ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì • ì™„ë£Œ"
        fi
        
        echo "ğŸ” MCP ì„œë²„ í™•ì¸:"
        ls -la github-mcp-server
        
        echo "ğŸ“‹ í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la
    
    - name: Request Copilot Review
      if: steps.check_copilot.outputs.skip_copilot == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ¤– GitHub Copilot ë¦¬ë·° ìš”ì²­ ì¤‘..."
        echo "ğŸ“ PR ë²ˆí˜¸: ${{ steps.check_copilot.outputs.pr_number }}"
        echo "ğŸ“ ì €ì¥ì†Œ: ${{ github.repository }}"
        
        # MCP ì„œë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ Copilot ë¦¬ë·° ìš”ì²­
        echo "ğŸ“± MCP ì„œë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­í•©ë‹ˆë‹¤..."
        
        # ì €ì¥ì†Œ ì •ë³´ ì¶”ì¶œ
        OWNER="${{ github.repository_owner }}"
        REPO="${{ github.event.repository.name }}"
        
        python3 .github-repo/.github/scripts/request_copilot_review.py \
          --owner "$OWNER" \
          --repo "$REPO" \
          --pr "${{ steps.check_copilot.outputs.pr_number }}"
